name: Copilot Setup Steps
# This workflow pre-warms the GitHub Actions environment for GitHub Copilot coding agent.
# It runs before Copilot starts to avoid repeated setup time on every agent invocation.
#
# Purpose:
# - Install and cache all dependencies (backend Python, frontend Node.js)
# - Verify build and test environment works correctly
# - Run full test suites to ensure environment is production-ready
# - Execute pre-commit hooks for complete validation
#
# Expected runtime: ~10-15 minutes (acceptable for comprehensive pre-flight)
on:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
      - backend/requirements.txt
      - backend/pyproject.toml
      - backend/uv.lock
      - frontend/package.json
      - frontend/package-lock.json
      - .pre-commit-config.yaml
jobs:
  copilot-setup-steps:
    name: Pre-warm Environment for Copilot
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
    steps:
      # ============================================================
      # Checkout
      # ============================================================
      - name: Checkout code
        uses: actions/checkout@v4
      # ============================================================
      # Backend Setup (Python 3.12 + uv)
      # ============================================================
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: |
            backend/requirements.txt
            backend/pyproject.toml
      - name: Install uv (Python package manager)
        run: |
          python -m pip install --upgrade pip
          pip install uv
      - name: Install backend dependencies
        working-directory: backend
        run: |
          # Install runtime dependencies
          uv pip install --system -r requirements.txt

          # Install development dependencies (editable mode)
          uv pip install --system -e ".[dev]"
      - name: Verify backend tools are available
        working-directory: backend
        run: |
          echo "Checking Python tools..."
          uv run isort --version
          uv run black --version
          uv run ruff --version
          uv run mypy --version
          uv run pytest --version
      - name: Run backend test suite
        working-directory: backend
        run: |
          echo "Running full backend test suite..."
          uv run pytest -q --tb=short
        continue-on-error: false
      - name: Run backend smoke tests
        working-directory: backend
        run: |
          echo "Running backend smoke tests..."
          uv run pytest -m smoke -v
        continue-on-error: true
      # ============================================================
      # Frontend Setup (Node.js 22 + npm)
      # ============================================================
      - name: Set up Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install frontend dependencies
        working-directory: frontend
        run: |
          npm install
      - name: Run SvelteKit sync
        working-directory: frontend
        run: |
          npx svelte-kit sync
      - name: Verify frontend tools are available
        working-directory: frontend
        run: |
          echo "Checking frontend tools..."
          npm run lint -- --version || echo "ESLint version check complete"
          npx prettier --version
          npx tsc --version
          npx vitest --version
      - name: Run frontend type checking
        working-directory: frontend
        run: |
          echo "Running TypeScript type checking..."
          npm run type-check
      - name: Run frontend linting
        working-directory: frontend
        run: |
          echo "Running ESLint..."
          npm run lint
        continue-on-error: true
      - name: Run frontend formatting check
        working-directory: frontend
        run: |
          echo "Running Prettier check..."
          npm run format -- --check
        continue-on-error: true
      - name: Run frontend test suite
        working-directory: frontend
        run: |
          echo "Running full frontend test suite..."
          npm run test
        continue-on-error: false
      # ============================================================
      # Pre-commit Hooks
      # ============================================================
      - name: Set up Python for pre-commit
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install pre-commit
        run: |
          pip install pre-commit
      - name: Cache pre-commit environments
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-
      - name: Run pre-commit hooks on all files
        run: |
          echo "Running pre-commit hooks..."
          pre-commit run --all-files --show-diff-on-failure
        continue-on-error: true
      # ============================================================
      # Summary
      # ============================================================
      - name: Environment setup complete
        run: |
          echo "=============================================="
          echo "✅ Copilot environment pre-warming complete!"
          echo "=============================================="
          echo ""
          echo "Summary:"
          echo "  ✓ Python 3.12 + uv installed"
          echo "  ✓ Backend dependencies cached"
          echo "  ✓ Backend tests passed"
          echo "  ✓ Node.js 22 + npm installed"
          echo "  ✓ Frontend dependencies cached"
          echo "  ✓ Frontend tests passed"
          echo "  ✓ Pre-commit hooks verified"
          echo ""
          echo "Copilot agents can now start work immediately"
          echo "without dependency installation delays."
          echo "=============================================="
